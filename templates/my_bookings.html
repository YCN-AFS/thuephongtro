{% extends 'layout.html' %}

{% block title %}Đặt phòng của tôi{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="mb-4">Đặt phòng của tôi</h1>
    
    {% if bookings %}
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="statusFilter" class="form-label">Lọc theo trạng thái:</label>
                    <select class="form-select" id="statusFilter">
                        <option value="all" selected>Tất cả</option>
                        <option value="pending">Đang chờ xác nhận</option>
                        <option value="confirmed">Đã xác nhận</option>
                        <option value="cancelled">Đã hủy</option>
                        <option value="completed">Đã hoàn thành</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="row">
            {% for booking in bookings %}
            <div class="col-md-6 mb-4 booking-item" data-status="{{ booking.status }}">
                <div class="card h-100 shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <a href="{{ url_for('property_details', property_id=booking.property_id) }}" class="text-decoration-none">
                                {{ booking.property.title }}
                            </a>
                        </h5>
                        <span class="badge {% if booking.status == 'pending' %}bg-warning
                                             {% elif booking.status == 'confirmed' %}bg-success
                                             {% elif booking.status == 'cancelled' %}bg-danger
                                             {% elif booking.status == 'completed' %}bg-info
                                             {% endif %}">
                            {{ {'pending': 'Đang chờ xác nhận', 'confirmed': 'Đã xác nhận', 'cancelled': 'Đã hủy', 'completed': 'Đã hoàn thành'}[booking.status] }}
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="booking-details">
                                    <p class="mb-2">
                                        <i class="fas fa-calendar-check me-2 text-primary"></i> <strong>Nhận phòng:</strong> {{ booking.check_in_date.strftime('%d/%m/%Y') }}
                                    </p>
                                    <p class="mb-2">
                                        <i class="fas fa-calendar-times me-2 text-primary"></i> <strong>Trả phòng:</strong> {{ booking.check_out_date.strftime('%d/%m/%Y') }}
                                    </p>
                                    <p class="mb-2">
                                        <i class="fas fa-user-friends me-2 text-primary"></i> <strong>Số khách:</strong> {{ booking.num_guests }}
                                    </p>
                                    <p class="mb-2">
                                        <i class="fas fa-money-bill-wave me-2 text-primary"></i> <strong>Tổng tiền:</strong> {{ "{:,.0f}".format(booking.total_price) }} VND
                                    </p>
                                    <p class="mb-2">
                                        <i class="fas fa-credit-card me-2 text-primary"></i> <strong>Thanh toán:</strong> 
                                        <span class="badge {% if booking.payment_status == 'paid' %}bg-success{% else %}bg-warning{% endif %}">
                                            {{ {'unpaid': 'Chưa thanh toán', 'paid': 'Đã thanh toán', 'refunded': 'Đã hoàn tiền'}[booking.payment_status] }}
                                        </span>
                                    </p>
                                    {% if booking.special_requests %}
                                    <p class="mb-0">
                                        <i class="fas fa-comment me-2 text-primary"></i> <strong>Yêu cầu đặc biệt:</strong>
                                        <br>
                                        <small class="text-muted">{{ booking.special_requests }}</small>
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    {% if booking.property.images %}
                                        {% for image in booking.property.images %}
                                            {% if image.is_primary %}
                                                <img src="{{ image.url }}" class="img-fluid rounded mb-2" alt="{{ booking.property.title }}">
                                                {% break %}
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <div class="no-image-placeholder rounded mb-2">
                                            <i class="fas fa-home fa-3x"></i>
                                        </div>
                                    {% endif %}
                                    
                                    <p class="small text-muted mb-0">Đặt ngày: {{ booking.created_at.strftime('%d/%m/%Y') }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-white">
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('property_details', property_id=booking.property_id) }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-eye me-1"></i> Xem phòng
                            </a>
                            
                            {% if booking.status == 'pending' or booking.status == 'confirmed' %}
                                <form action="{{ url_for('cancel_booking', booking_id=booking.id) }}" method="POST" class="d-inline">
                                    <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Bạn có chắc chắn muốn hủy đặt phòng này?')">
                                        <i class="fas fa-times-circle me-1"></i> Hủy đặt phòng
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i> Bạn chưa đặt phòng nào. <a href="{{ url_for('index') }}">Tìm phòng ngay</a>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const statusFilter = document.getElementById('statusFilter');
        const bookingItems = document.querySelectorAll('.booking-item');
        
        if (statusFilter) {
            statusFilter.addEventListener('change', function() {
                const selectedStatus = this.value;
                
                bookingItems.forEach(item => {
                    if (selectedStatus === 'all' || item.dataset.status === selectedStatus) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }
    });
</script>
{% endblock %}